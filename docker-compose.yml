# Docker Compose file for Go and PHP applications with PostgreSQL
version: "3.8"

services:
  # PostgreSQL Database Service
  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: app_main
      GOLANG_DB: app_golang
      GOLANG_DB_USER: golang_user
      GOLANG_DB_PASSWORD: ${GOLANG_DB_PASSWORD:-golang123}
      PHP_DB: app_php
      PHP_DB_USER: php_user
      PHP_DB_PASSWORD: ${PHP_DB_PASSWORD:-php123}
    ports:
      - "127.0.0.1:55432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d app_main"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Go Application Service
  golang:
    build:
      context: ./golang
      dockerfile: go.containerfile
    image: golang:v0.1
    container_name: golang-app
    ports:
      - "127.0.0.1:9191:80"
    volumes:
      - ./golang/tmp/file.p12:/app/file.p12
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: app_golang
      DB_USER: golang_user
      DB_PASSWORD: ${GOLANG_DB_PASSWORD:-golang123}
      DB_SSL_MODE: disable
      APP_ENV: local
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - postgres

  # PHP Application Service
  php:
    build:
      context: ./php
      dockerfile: php.containerfile
    image: php:v0.1
    container_name: php-app
    ports:
      - "127.0.0.1:9090:80"
    volumes:
      - ./php/config.prod:/var/www/html/config
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: app_php
      DB_USER: php_user
      DB_PASSWORD: ${PHP_DB_PASSWORD:-php123}
      DB_SSL_MODE: false
      APP_ENV: prod # required per app, is it a bug?
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - postgres

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
